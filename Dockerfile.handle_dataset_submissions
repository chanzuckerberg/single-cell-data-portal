FROM public.ecr.aws/lambda/python:3.9

COPY backend/__init__.py ./backend/__init.py
COPY backend/corpora/__init__.py ./backend/corpora/__init__.py
COPY backend/corpora/common ./backend/corpora/common
COPY backend/corpora/dataset_submissions .

# TODO: remove after the authz refactoring (_owner_or_allowed)
COPY backend/corpora/lambdas/__init__.py ./backend/corpora/lambdas/__init__.py
COPY backend/corpora/lambdas/api/__init__.py ./backend/corpora/lambdas/api/__init__.py
COPY backend/corpora/lambdas/api/v1/__init__.py ./backend/corpora/lambdas/api/v1/__init__.py
COPY backend/corpora/lambdas/api/v1/collection.py ./backend/corpora/lambdas/api/v1/collection.py
COPY backend/corpora/lambdas/api/v1/authorization.py ./backend/corpora/lambdas/api/v1/authorization.py
COPY backend/corpora/lambdas/api/v1/authentication.py ./backend/corpora/lambdas/api/v1/authentication.py
COPY backend/corpora/lambdas/api/v1/collection_uuid ./backend/corpora/lambdas/api/v1/collection_uuid
COPY backend/corpora/api_server/__init__.py ./backend/corpora/api_server/__init__.py
COPY backend/corpora/api_server/db.py ./backend/corpora/api_server/db.py

# For lighter weight Docker images
ENV PIP_NO_CACHE_DIR=1

RUN pip3 install -r requirements.txt

ARG HAPPY_BRANCH="unknown"
ARG HAPPY_COMMIT=""
LABEL branch=${HAPPY_BRANCH}
LABEL commit=${HAPPY_COMMIT}
ENV COMMIT_SHA=${HAPPY_COMMIT}
ENV COMMIT_BRANCH=${HAPPY_BRANCH}

CMD ["app.dataset_submissions_handler"]
