openapi: 3.0.3
info:
  version: "1.0.0"
  title: Chan Zuckerberg Initiative cellxgene Differential Expression (DE) API
  description: >-
    This API is for internal use only by DE web client.
servers:
  - description: Local
    url: /
  - description: Production environment
    url: https://api.cellxgene.cziscience.com/
  - description: Development environment
    url: https://api.dev.single-cell.czi.technology/
  - description: Staging environment
    url: https://api.staging.single-cell.czi.technology/

paths:
  /v1/filters:
    post:
      summary: Given a set of query criteria, returns the valid secondary filter and tissue terms
      tags:
        - de
      operationId: backend.de.api.v1.filters
      parameters: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                filter:
                  type: object
                  required:
                    - organism_ontology_term_id
                  properties:
                    organism_ontology_term_id:
                      type: string
                    tissue_ontology_term_ids:
                      $ref: "#/components/schemas/de_ontology_term_id_list"
                    dataset_ids:
                      type: array
                      items:
                        type: string
                        format: uuid
                    disease_ontology_term_ids:
                      $ref: "#/components/schemas/de_ontology_term_id_list"
                    sex_ontology_term_ids:
                      $ref: "#/components/schemas/de_ontology_term_id_list"
                    development_ontology_stage_term_ids:
                      $ref: "#/components/schemas/de_ontology_term_id_list"
                    self_reported_ethnicity_ontology_term_ids:
                      $ref: "#/components/schemas/de_ontology_term_id_list"
                    cell_type_ontology_term_ids:
                      $ref: "#/components/schemas/de_ontology_term_id_list"
              required:
                - filter
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required:
                  - filter_dims
                properties:
                  snapshot_id:
                    $ref: "#/components/schemas/de_snapshot_id"
                  filter_dims:
                    type: object
                    properties:
                      datasets:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                              format: uuid
                            label:
                              type: string
                            collection_label:
                              type: string
                            collection_url:
                              type: string
                              format: url
                      disease_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
                      sex_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
                      development_stage_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
                      self_reported_ethnicity_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
                      tissue_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
                      cell_type_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
                      organism_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
  /v1/deQuery:
    post:
      summary: Given a user query string, return the translated DE query criteria
      tags:
        - deQuery
      operationId: backend.de.api.v1.getDeQuery
      parameters: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                user_query:
                  type: string
              required:
                - user_query
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required:
                  - query_criteria1
                  - query_criteria2
                properties:
                  snapshot_id:
                    $ref: "#/components/schemas/de_snapshot_id"
                  query_criteria1:
                    type: object
                    properties:
                      disease_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
                      sex_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
                      development_stage_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
                      self_reported_ethnicity_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
                      tissue_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
                      cell_type_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
                      organism_term:
                        type: string
                  query_criteria2:
                    type: object
                    properties:
                      disease_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
                      sex_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
                      development_stage_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
                      self_reported_ethnicity_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
                      tissue_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
                      cell_type_terms:
                        $ref: "#/components/schemas/de_ontology_term_id_label_list"
                      organism_term:
                        type: string

  /v1/differentialExpression:
    post:
      summary: Prototype ifferential expression endpoint.
      tags:
        - de
      operationId: backend.de.api.v1.differentialExpression
      parameters: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                queryGroup1Filters:
                  type: object
                  properties:
                    organism_ontology_term_id:
                      type: string
                    tissue_ontology_term_ids:
                      $ref: "#/components/schemas/de_ontology_term_id_list"
                    dataset_ids:
                      type: array
                      items:
                        type: string
                        format: uuid
                    disease_ontology_term_ids:
                      $ref: "#/components/schemas/de_ontology_term_id_list"
                    sex_ontology_term_ids:
                      $ref: "#/components/schemas/de_ontology_term_id_list"
                    development_ontology_stage_term_ids:
                      $ref: "#/components/schemas/de_ontology_term_id_list"
                    self_reported_ethnicity_ontology_term_ids:
                      $ref: "#/components/schemas/de_ontology_term_id_list"
                    cell_type_ontology_term_ids:
                      $ref: "#/components/schemas/de_ontology_term_id_list"
                  required:
                    - organism_ontology_term_id
                queryGroup2Filters:
                  type: object
                  properties:
                    organism_ontology_term_id:
                      type: string
                    tissue_ontology_term_ids:
                      $ref: "#/components/schemas/de_ontology_term_id_list"
                    dataset_ids:
                      type: array
                      items:
                        type: string
                        format: uuid
                    disease_ontology_term_ids:
                      $ref: "#/components/schemas/de_ontology_term_id_list"
                    sex_ontology_term_ids:
                      $ref: "#/components/schemas/de_ontology_term_id_list"
                    development_ontology_stage_term_ids:
                      $ref: "#/components/schemas/de_ontology_term_id_list"
                    self_reported_ethnicity_ontology_term_ids:
                      $ref: "#/components/schemas/de_ontology_term_id_list"
                    cell_type_ontology_term_ids:
                      $ref: "#/components/schemas/de_ontology_term_id_list"
                  required:
                    - organism_ontology_term_id
              required:
                - queryGroup1Filters
                - queryGroup2Filters
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required:
                  - differentialExpressionResults1
                  - differentialExpressionResults2
                  - pathwayEnrichmentAnalysisResults1
                  - pathwayEnrichmentAnalysisResults2
                properties:
                  snapshot_id:
                    $ref: "#/components/schemas/de_snapshot_id"
                  successCode:
                    description: ->
                      Code indicating whether the query returned too many cells to compute differential expression.
                    type: integer
                  differentialExpressionResults1:
                    description: ->
                      Differential expression results for cell group 1
                    type: array
                    items:
                      description: ->
                        Object with gene id, p-value, and effect size.
                      type: object
                      properties:
                        gene_ontology_term_id:
                          description: gene ontology term id
                          type: string
                        gene_symbol:
                          description: gene symbol
                          type: string
                        p_value:
                          description: adjusted p-value
                          type: number
                          format: float
                          maxLength: 4
                          minimum: 0.0
                          maximum: 1.0
                        effect_size:
                          description: effect size
                          type: number
                          format: float
                          maxLength: 4
                  differentialExpressionResults2:
                    description: ->
                      Differential expression results for cell group 2
                    type: array
                    items:
                      description: ->
                        Object with gene id, p-value, and effect size.
                      type: object
                      properties:
                        gene_ontology_term_id:
                          description: gene ontology term id
                          type: string
                        gene_symbol:
                          description: gene symbol
                          type: string
                        p_value:
                          description: adjusted p-value
                          type: number
                          format: float
                          maxLength: 4
                          minimum: 0.0
                          maximum: 1.0
                        effect_size:
                          description: effect size
                          type: number
                          format: float
                          maxLength: 4
                  pathwayEnrichmentAnalysisResults1:
                    description: ->
                      Pathway enrichment analysis results for differentially expressed genes in cell group 1
                    type: array
                    items:
                      description: ->
                        Object with FDR q-value, gene set, p-value, and DE genes in the gene set
                      type: object
                      properties:
                        gene_set:
                          description: gene set name
                          type: string
                        gene_symbols:
                          description: DE gene symbols in the gene set
                          type: string
                        p_value:
                          description: adjusted p-value
                          type: number
                          format: float
                          maxLength: 4
                          minimum: 0.0
                          maximum: 1.0
                        fdr_q_value:
                          description: FDR q-value
                          type: number
                          format: float
                          maxLength: 4
                          minimum: 0.0
                          maximum: 1.0
                  pathwayEnrichmentAnalysisResults2:
                    description: ->
                      Pathway enrichment analysis results for differentially expressed genes in cell group 2
                    type: array
                    items:
                      description: ->
                        Object with FDR q-value, gene set, p-value, and DE genes in the gene set
                      type: object
                      properties:
                        gene_set:
                          description: gene set name
                          type: string
                        gene_symbols:
                          description: DE gene symbols in the gene set
                          type: string
                        p_value:
                          description: adjusted p-value
                          type: number
                          format: float
                          maxLength: 4
                          minimum: 0.0
                          maximum: 1.0
                        fdr_q_value:
                          description: FDR q-value
                          type: number
                          format: float
                          maxLength: 4
                          minimum: 0.0
                          maximum: 1.0

components:
  schemas:
    problem:
      type: object
      description: Error message container for HTTP APIs.
      properties:
        type:
          type: string
        title:
          type: string
        detail:
          type: string
    de_ontology_term_id_label_list:
      description: ->
        An array of ontology term ids and labels, where array elements are single-element objects of the
        form "<id>":"<label>"
      type: array
      items:
        description: ->
          A single-element object with the ontology term id as the element's property name and the ontology term label
          as the element's property value.
        type: object
        # TODO: fix: https://app.zenhub.com/workspaces/single-cell-5e2a191dad828d52cc78b028/issues/chanzuckerberg/single-cell-data-portal/1967
        # `{"<ontology_term_id>": "<ontology_term_label"}`
    #        maxProperties: 1
    #        additionalProperties:
    #          type: string
    de_ontology_term_id_list:
      type: array
      items:
        type: string
    de_snapshot_id:
      type: string
      format: uuid

  parameters: {}

  responses:
    200:
      description: OK.
    201:
      description: Created.
    202:
      description: Accepted
    204:
      description: No Content
    400:
      description: Invalid parameter.
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/problem"
    401:
      description: Failed to authenticate.
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/problem"
    403:
      description: Unauthorized.
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/problem"
    404:
      description: Resource not found.
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/problem"
    405:
      description: Method not allowed.
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/problem"
    409:
      description: File conflict.
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/problem"
    413:
      description: Exceed File Size Limit
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/problem"

  securitySchemes: {}
