openapi: 3.0.0
info:
  version: "1.0.0"
  title: Chan Zuckerburg Initiative cellxgene Data Portal Curator API
servers:
paths:
  /curation/auth/key:
    post:
      summary: Generate the curator's API key -- for use with Data Portal UI
      description: >-
        Generate and return a curator API key for the user. If there is already a key associated with the
        user's auth profile, replace it with the new key.
      security:
        - cxguserCookie: []
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  key:
                    type: string
                  id:
                    type: string
        "401":
          $ref: "#/components/responses/401"
        "400":
          $ref: "#/components/responses/400"
    get:
      summary: Fetch the identifier of the curator's active API key -- for use with Data Portal UI
      security:
        - cxguserCookie: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: string
        "401":
          $ref: "#/components/responses/401"
        "404":
          $ref: "#/components/responses/404"
    delete:
      summary: Delete the curator's API key -- for use with Data Portal UI
      security:
        - cxguserCookie: []
      responses:
        "202":
          $ref: "#/components/responses/202"
        "401":
          $ref: "#/components/responses/401"

  /curation/auth/token:
    post:
      summary: Generate an access token
      description: >-
        Returns a bearer access token that must be passed as a parameter to requests that
        require authorization such as creating a new Collection.
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
        "401":
          $ref: "#/components/responses/401"

  /curation/collections:
    get:
      summary: Fetch Collections metadata.
      description: Fetch all Collections metadata. Authorization required for private collections.
      security:
        - cxguserCookie: []
        - curatorAccess: []
        - {}
      parameters:
        - $ref: "#/components/parameters/query_visibility"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  collections:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          $ref: "#/components/schemas/collection_uuid"
                        name:
                          type: string
                        visibility:
                          $ref: "#/components/schemas/visibility"
                        contact_name:
                          type: string
                        contact_email:
                          type: string
                        curator_name:
                          type: string
                        revised_at:
                          type: number
                        created_at:
                          type: number
                        links:
                          $ref: "#/components/schemas/links"
                        datasets:
                          type: array
                          items:
                            $ref: "#/components/schemas/dataset_preview"
                        access_type:
                          type: string
                          enum: [ READ, WRITE ]
                        published_at:
                          type: number
                        description:
                          type: string
                        data_submission_policy_version:
                          type: string
                        publisher_metadata:
                          $ref: "#/components/schemas/publisher_metadata"
        "401":
          $ref: "#/components/responses/401"
    post:
      summary: Create a Collection
      description: Create a new Collection
      security:
        - cxguserCookie: []
        - curatorAccess: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/collection_form_metadata"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/collection_uuid"
        "400":
          $ref: "#/components/responses/400_multiple"
        "401":
          $ref: "#/components/responses/401"

  /curation/collections/{collection_uuid}:
    delete:
      summary: Delete a private Collection
      description: Delete a private Collection. Delete an existing revision for a public Collection.
      security:
        - cxguserCookie: []
      parameters:
        - $ref: "#/components/parameters/path_collection_uuid"
      responses:
        "202":
          description: Accepted
          content:
            application/json:
              schema:
                type: string
        "401":
          $ref: "#/components/responses/401"
    get:
      summary: Fetch a Collection with Datasets
      description: Fetch Collection metadata and associated Datasets, public and private.
      security:
        - cxguserCookie: []
        - curatorAccess: []
        - {}
      parameters:
        - $ref: "#/components/parameters/path_collection_uuid"
        - $ref: "#/components/parameters/query_visibility"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                  visibility:
                    $ref: "#/components/schemas/visibility"
                  contact_name:
                    type: string
                  contact_email:
                    type: string
                  curator_name:
                    type: string
                  revised_at:
                    type: number
                  created_at:
                    type: number
                  links:
                    $ref: "#/components/schemas/links"
                  datasets:
                    type: array
                    items:
                      $ref: "#/components/schemas/dataset"
                  access_type:
                    type: string
                    enum: [ READ, WRITE ]
                  published_at:
                    type: number
                  description:
                    type: string
                  data_submission_policy_version:
                    type: string
                  publisher_metadata:
                    $ref: "#/components/schemas/publisher_metadata"
        "401":
          $ref: "#/components/responses/401"
        "404":
          $ref: "#/components/responses/404"
    put:
      summary: Start or update a revision
      description: Start a revision of a Collection. Update any included Collection metadata fields.
      security:
        - cxguserCookie: []
        - curatorAccess: []
      parameters:
        - $ref: "#/components/parameters/path_collection_uuid"
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/collection_form_metadata"
      responses:
        "200":
          $ref: "#/components/responses/200"
        "201":
          $ref: "#/components/responses/201"
        "400":
          $ref: "#/components/responses/400_multiple"
        "401":
          $ref: "#/components/responses/401"
        "404":
          $ref: "#/components/responses/404"

  /curation/collections/{collection_uuid}/datasets:
    delete:
      summary: Delete a private Dataset
      description: Delete a private Dataset.
      security:
        - cxguserCookie: []
        - curatorAccess: []
      parameters:
        - $ref: "#/components/parameters/path_collection_uuid"
        - $ref: "#/components/parameters/optional_query_curator_tag"
        - $ref: "#/components/parameters/optional_query_dataset_uuid"
      responses:
        "202":
          description: Accepted
          content:
            application/json:
              schema:
                type: string
        "401":
          $ref: "#/components/responses/401"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"
    patch:
      summary: Update a Dataset's curator tag.
      description: >-
        Update a Dataset's curator-provided tag. Must indicate the Dataset by providing either the current curator
        tag OR the Dataset uuid.
      security:
        - cxguserCookie: []
        - curatorAccess: []
      parameters:
        - $ref: "#/components/parameters/path_collection_uuid"
        - $ref: "#/components/parameters/optional_query_curator_tag"
        - $ref: "#/components/parameters/optional_query_dataset_uuid"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              additionalProperties: false
              properties:
                curator_tag:
                  type: string
                  description: curator-provided tag
      responses:
        "204":
          $ref: "#/components/responses/204"
        "400":
          $ref: "#/components/responses/400_multiple"
        "401":
          $ref: "#/components/responses/401"
        "404":
          $ref: "#/components/responses/404"

  /curation/collections/{collection_uuid}/datasets/upload-link:
    put:
      summary: Upload a Dataset by providing a link
      description: Upload a Dataset. The Dataset will be uploaded from the provided link.
      security:
        - cxguserCookie: []
        - curatorAccess: []
      parameters:
        - $ref: "#/components/parameters/path_collection_uuid"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              additionalProperties: false
              properties:
                curator_tag:
                  type: string
                id:
                  $ref: "#/components/schemas/dataset_uuid"
                link:
                  $ref: "#/components/schemas/upload_link"
      responses:
        "202":
          $ref: "#/components/responses/202"
        "400":
          $ref: "#/components/responses/400_multiple"
        "401":
          $ref: "#/components/responses/401"
        "404":
          $ref: "#/components/responses/404"

  /curation/collections/{collection_uuid}/datasets/upload-s3:
    put:
      summary: Get credentials for uploading local files
      description: >
        Retrieve temporary AWS credentials for uploading Dataset source files to S3 to create
        or update Datasets for the specified Collection.
      security:
        - cxguserCookie: []
        - curatorAccess: []
      parameters:
        - $ref: "#/components/parameters/path_collection_uuid"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  credentials:
                    type: object
                    properties:
                      access_key:
                        type: string
                      secret_access_key:
                        type: string
                      session_token:
                        type: string
        "401":
          $ref: "#/components/responses/401"

  /curation/collections/{collection_uuid}/datasets/status:
    get:
      summary: Get a Dataset's processing status
      description: Get the processing status for a Dataset.
      security:
        - cxguserCookie: []
        - curatorAccess: []
      parameters:
        - $ref: "#/components/parameters/path_collection_uuid"
        - $ref: "#/components/parameters/optional_query_curator_tag"
        - $ref: "#/components/parameters/optional_query_dataset_uuid"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [FAILURE, PENDING, SUCCESS]
                  file_statuses:
                    type: object
                    properties:
                      cxg:
                        description: status for cxg conversion
                        $ref: "#/components/schemas/conversion_status"
                      h5ad:
                        description: status for h5ad conversion
                        $ref: "#/components/schemas/conversion_status"
                      rds:
                        description: status for rds/seurat conversion
                        $ref: "#/components/schemas/conversion_status"

  /curation/collections/{collection_uuid}/asset:
    get:
      summary: Retrieve links for downloading a dataset
      description: >-
        Request to download a file which on success will generate and return a pre-signed URL to download the dataset.
      parameters:
        - $ref: "#/components/parameters/path_collection_uuid"
        - $ref: "#/components/parameters/optional_query_curator_tag"
        - $ref: "#/components/parameters/optional_query_dataset_uuid"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  dataset_uuid:
                    $ref: "#/components/schemas/dataset_uuid"
                  curator_tag:
                    $ref: "#/components/schemas/curator_tag"
                  assets:
                    type: array
                    items:
                      type: object
                      properties:
                        presigned_url:
                          type: string
                        file_name:
                          type: string
                        file_size:
                          type: number
        "400":
          $ref: "#/components/responses/400"
        "401":
          $ref: "#/components/responses/401"
        "404":
          $ref: "#/components/responses/404"

components:
  schemas:
    collection_uuid:
      description: A unique identifier of a Collection.
      type: string
    conversion_status:
      description: Status of a dataset file conversion
      type: string
      enum: [ CONVERTED, CONVERTING, FAILED, NA, UPLOADING, UPLOADED, SKIPPED ]
    curator_tag:
      description: A curator-provided tag that is unique within a Collection.
      type: string
    dataset_uuid:
      description: A unique identifier of a Dataset.
      type: string
    visibility:
      description: >-
        Determines the visibility of the collection, that will either make the collection visible on the public
        sites or only viewable through obfuscated URLs.
      type: string
      enum: [PUBLIC, PRIVATE, REVISION]
    distribution:
      description: >-
        Cellxgene runs a heuristic to detect the approximate distribution of the data in X so that it can accurately
        calculate statistical properties of the data. This field enables the curator to override this heuristic
        and specify the data distribution explicitly.
      type: string
      enum: [COUNT, NORMAL]
    is_primary_data:
      description: >-
        Describes whether cellular observations for this dataset are all canonical (PRIMARY),
        all non-canonical (SECONDARY), or contain a mixture (BOTH).
      type: string
      enum: [PRIMARY, SECONDARY, BOTH]
    links:
      type: array
      items:
        type: object
        additionalProperties: false
        required:
          - link_url
          - link_type
        properties:
          link_name:
            type: string
          link_url:
            type: string
          link_type:
            type: string
            enum: [PROTOCOL, RAW_DATA, DOI, LAB_WEBSITE, OTHER, DATA_SOURCE]
    dataset:
      allOf:
        - $ref: "#/components/schemas/dataset_preview"
        - type: object
          properties:
            name:
              type: string
            revision:
              type: integer
            collection_id:
              $ref: "#/components/schemas/collection_uuid"
            collection_visibility:
              $ref: "#/components/schemas/visibility"
            revised_at:
              type: number
            is_primary_data:
              $ref: "#/components/schemas/is_primary_data"
            X_normalization:
              type: string
            dataset_assets:
              type: array
              items:
                $ref: "#/components/schemas/dataset_asset"
            sex:
              $ref: "#/components/schemas/ontology_elements"
            ethnicity:
              $ref: "#/components/schemas/ontology_elements"
            development_stage:
              $ref: "#/components/schemas/ontology_elements"
            dataset_deployments:
              type: array
              items:
                type: object
                properties:
                  url:
                    type: string
            cell_type:
              $ref: "#/components/schemas/ontology_elements"
            cell_count:
              type: integer
            X_approximate_distribution:
              $ref: "#/components/schemas/distribution"
            schema_version:
              type: string
    dataset_preview:
      type: object
      properties:
        id:
          $ref: "#/components/schemas/dataset_uuid"
        curator_tag:
          $ref: "#/components/schemas/curator_tag"
        tissue:
          $ref: "#/components/schemas/ontology_elements"
        assay:
          $ref: "#/components/schemas/ontology_elements"
        disease:
          $ref: "#/components/schemas/ontology_elements"
        organism:
          $ref: "#/components/schemas/ontology_elements"
        tombstone:
          type: boolean
    dataset_asset:
      type: object
      properties:
        filetype:
          type: string
          enum: [H5AD, RDS]
        filename:
          type: string
    ontology_element:
      type: object
      properties:
        ontology_term_id:
          type: string
        label:
          type: string
    ontology_elements:
      type: array
      items:
        $ref: "#/components/schemas/ontology_element"
    problem:
      type: object
      description: Error message container for HTTP APIs.
      properties:
        type:
          type: string
        title:
          type: string
        detail:
          type: string
    publisher_metadata:
      type: object
      required:
        - authors
        - is_preprint
        - journal
        - published_year
      properties:
        authors:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              given:
                type: string
              family:
                type: string
        is_preprint:
          type: boolean
        journal:
          type: string
        published_day:
          type: number
        published_month:
          type: number
        published_year:
          type: number
    collection_form_metadata:
      type: object
      additionalProperties: false
      required:
        - name
        - description
        - contact_name
        - contact_email
        - curator_name
      properties:
        name:
          type: string
          description: name of the collection
        description:
          type: string
          description: description of the collection
        contact_name:
          type: string
          description: name of the primary person of contact for the collection
        contact_email:
          type: string
          description: email of contact person for the collection
        curator_name:
          type: string
          description: name of the curator of the collection.
        links:
          $ref: "#/components/schemas/links"
    upload_link:
      description: A user-provided link to the dataset source file.
      type: string

  parameters:
    optional_query_curator_tag:
      name: curator_tag
      description: A curator-provided tag. Must be unique within a given Collection.
      in: query
      required: false
      schema:
        $ref: "#/components/schemas/curator_tag"
    optional_query_dataset_uuid:
      name: dataset_uuid
      description: The uuid of the Dataset.
      in: query
      required: false
      schema:
        $ref: "#/components/schemas/dataset_uuid"
    path_collection_uuid:
      name: collection_uuid
      description: >
        The uuid of a collection. To specify the private revision of a public
        collection, use the uuid of the public collection.
      in: path
      required: true
      schema:
        $ref: "#/components/schemas/collection_uuid"
    query_visibility:
      name: visibility
      in: query
      schema:
        $ref: "#/components/schemas/visibility"
        default: PUBLIC

  responses:
    200:
      description: OK
    201:
      description: Created
    202:
      description: Accepted
    204:
      description: No content
    400:
      description: Invalid or missing parameter
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/problem"
    400_multiple:
      description: Invalid or missing parameters
      content:
        application/problem+json:
          schema:
            type: array
            items:
              type: object
              properties:
                name:
                  type: string
                  description: the errant parameter
                reason:
                  type: string
                  description: the specific problem with the parameter
    401:
      description: Failed to authenticate
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/problem"
    403:
      description: Forbidden
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/problem"
    404:
      description: Resource not found
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/problem"
    405:
      description: Method not allowed
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/problem"
    409:
      description: File conflict
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/problem"
    413:
      description: Exceed File Size Limit
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/problem"
  securitySchemes:
    cxguserCookie:
      type: apiKey
      in: cookie
      name: cxguser
      x-apikeyInfoFunc: backend.corpora.lambdas.api.v1.authentication.apikey_info_func
    curatorAccess:
      type: http
      scheme: bearer
      bearerFormat: JWT
      x-bearerInfoFunc: backend.corpora.lambdas.api.v1.authentication.apikey_info_func
